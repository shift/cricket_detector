<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Directional Beep Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .amp-bar-container { background-color: #374151; }
        .amp-bar { background: linear-gradient(90deg, #10B981 0%, #F59E0B 70%, #EF4444 100%); transition: width 0.3s ease-in-out; }
        #radarCanvas { background-color: #1f2937; }
        .modal-backdrop { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-blue-400">Directional Detector</h1>
            <p class="text-gray-400 mt-2">Using compass and loudness to find the source.</p>
        </div>

        <!-- Controls -->
        <div class="space-y-4 p-4 bg-gray-900/50 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <button id="startButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">
                    Start Detection
                </button>
                 <button id="analyzeHistoryButton" disabled class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed">
                    Heard It! Analyze Last 5s
                </button>
            </div>
             <div class="pt-4">
                 <button id="compassButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">
                    Enable Compass
                </button>
            </div>
        </div>
        
        <!-- Active Targets UI -->
        <div class="space-y-2 p-3 bg-gray-900/50 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 text-center">Active Targets</h3>
            <div id="targetsContainer" class="flex flex-wrap gap-2 justify-center">
                <!-- Tracked frequencies will be injected here -->
            </div>
        </div>

        <!-- Direction Finder -->
        <div class="space-y-3">
            <div class="w-full aspect-square rounded-full mx-auto max-w-xs shadow-lg mt-4">
                <canvas id="radarCanvas"></canvas>
            </div>
             <div id="compassStatus" class="text-center text-sm text-gray-400 mt-2">Compass inactive.</div>
        </div>

        <!-- Detection Log -->
        <div class="space-y-3">
            <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold text-gray-300">Detection Log</h2>
                 <button id="clearLogButton" class="text-sm text-gray-400 hover:text-white">Clear</button>
            </div>
            <div id="logContainer" class="w-full h-40 bg-gray-900/50 rounded-lg p-3 space-y-2 overflow-y-auto">
                <p id="logPlaceholder" class="text-gray-500 text-center pt-4">Waiting for detections...</p>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0 bg-black/50"></div>
        <div class="relative bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg m-4 p-6">
            <h2 class="text-2xl font-bold text-blue-400 mb-4">Look-back Analysis</h2>
            <p class="text-gray-400 mb-4">Click on a bright spot in the spectrogram below to analyze a specific sound event.</p>
            <div class="bg-gray-900 rounded-lg overflow-hidden">
                <canvas id="spectrogramCanvas"></canvas>
            </div>
            <div id="peakInfo" class="mt-4 text-center hidden">
                <p class="text-lg">Selected Peak: <span id="peakFreq" class="font-bold text-teal-300"></span></p>
                <div class="flex gap-4 justify-center mt-4">
                    <button id="playToneButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Play Tone</button>
                    <button id="trackFreqButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Track this Frequency</button>
                </div>
            </div>
            <button id="closeModalButton" class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
        </div>
    </div>

    <!-- SCRIPT LOADING (CORRECTED FOR DEPLOYMENT) -->
    <script>
        function startApp(Module) {
            // DOM Elements
            const startButton = document.getElementById('startButton');
            const analyzeHistoryButton = document.getElementById('analyzeHistoryButton');
            const compassButton = document.getElementById('compassButton');
            const clearLogButton = document.getElementById('clearLogButton');
            const compassStatusEl = document.getElementById('compassStatus');
            const logContainer = document.getElementById('logContainer');
            const logPlaceholder = document.getElementById('logPlaceholder');
            const radarCanvas = document.getElementById('radarCanvas');
            const radarCtx = radarCanvas.getContext('2d');
            const targetsContainer = document.getElementById('targetsContainer');
            
            // Modal Elements
            const analysisModal = document.getElementById('analysisModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const spectrogramCanvas = document.getElementById('spectrogramCanvas');
            const spectrogramCtx = spectrogramCanvas.getContext('2d');
            const peakInfo = document.getElementById('peakInfo');
            const peakFreqEl = document.getElementById('peakFreq');
            const playToneButton = document.getElementById('playToneButton');
            const trackFreqButton = document.getElementById('trackFreqButton');

            // App State
            let audioContext, analyser, detectorPtr, dataPtr, liveFreqPtr, targetsPtr;
            let animationFrameId;
            let currentHeading = 0;
            let selectedPeakFrequency = 0;
            const detectionLog = [];
            const historyBuffer = [];
            const HISTORY_SIZE = 250; 
            let TARGET_FREQUENCIES; // Will be loaded from storage
            const SENSITIVITY = 200;

            const wasmModule = Module;
            detectorPtr = wasmModule._detector_new();
            const bufferSize = 2048;

            dataPtr = wasmModule._malloc(bufferSize * Uint8Array.BYTES_PER_ELEMENT);
            liveFreqPtr = wasmModule._malloc(4);
            
            // --- Frequency Management with localStorage ---
            function loadTrackedFrequencies() {
                const defaultFrequencies = [4000.0, 5000.0, 12000.0];
                let savedFrequencies = [];
                try {
                    const stored = localStorage.getItem('trackedFrequencies');
                    if (stored) {
                        savedFrequencies = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error("Could not parse saved frequencies:", e);
                    localStorage.removeItem('trackedFrequencies');
                }
                // Combine and ensure no duplicates
                const allFrequencies = [...new Set([...defaultFrequencies, ...savedFrequencies])];
                TARGET_FREQUENCIES = new Float32Array(allFrequencies);
            }

            function saveTrackedFrequencies() {
                // Don't save the default frequencies, only user-added ones.
                const userFrequencies = Array.from(TARGET_FREQUENCIES).filter(f => ![4000, 5000, 12000].includes(f));
                localStorage.setItem('trackedFrequencies', JSON.stringify(userFrequencies));
            }

            function updateWasmTargets() {
                if (targetsPtr) wasmModule._free(targetsPtr);
                targetsPtr = wasmModule._malloc(TARGET_FREQUENCIES.byteLength);
                wasmModule.HEAPF32.set(TARGET_FREQUENCIES, targetsPtr / Float32Array.BYTES_PER_ELEMENT);
                updateTargetsUI();
            }

            function updateTargetsUI() {
                targetsContainer.innerHTML = '';
                TARGET_FREQUENCIES.forEach(freq => {
                    const badge = document.createElement('span');
                    badge.className = 'bg-blue-600 text-white text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full flex items-center';
                    badge.innerHTML = `${(freq / 1000).toFixed(1)} kHz`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'ml-2 text-blue-200 hover:text-white';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => {
                        TARGET_FREQUENCIES = new Float32Array(Array.from(TARGET_FREQUENCIES).filter(f => f !== freq));
                        saveTrackedFrequencies();
                        updateWasmTargets();
                    };
                    badge.appendChild(removeBtn);
                    targetsContainer.appendChild(badge);
                });
            }
            
            // --- Initialization ---
            loadTrackedFrequencies();
            updateWasmTargets();
            console.log("WASM module initialized and app started.");

            // --- Control Logic ---
            startButton.addEventListener('click', async () => {
                if (startButton.dataset.running === 'true') stopDetection();
                else await startDetection();
            });

            analyzeHistoryButton.addEventListener('click', showAnalysisModal);
            closeModalButton.addEventListener('click', () => analysisModal.style.display = 'none');
            analysisModal.querySelector('.modal-backdrop').addEventListener('click', () => analysisModal.style.display = 'none');

            compassButton.addEventListener('click', requestOrientationPermission);
            
            clearLogButton.addEventListener('click', () => {
                detectionLog.length = 0;
                updateLogUI();
                drawRadar();
            });

            async function startDetection() {
                if (!wasmModule) return;
                if (!audioContext) await setupAudio();
                if (audioContext.state === 'suspended') await audioContext.resume();
                startButton.dataset.running = 'true';
                startButton.textContent = "Stop Detection";
                startButton.classList.replace('bg-blue-600', 'bg-red-600');
                analyzeHistoryButton.disabled = false;
                recordAndDetect();
            }

            function stopDetection() {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                if (audioContext) audioContext.suspend();
                startButton.dataset.running = 'false';
                startButton.textContent = "Start Detection";
                startButton.classList.replace('bg-red-600', 'bg-blue-600');
                analyzeHistoryButton.disabled = true;
            }

            async function setupAudio() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = bufferSize;
                    analyser.smoothingTimeConstant = 0.1;
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                } catch (err) { console.error("Mic Error:", err); }
            }

            function requestOrientationPermission() { /* ... unchanged ... */ }
            function handleOrientation(event) { /* ... unchanged ... */ }
            function recordAndDetect() { /* ... unchanged ... */ }
            function showAnalysisModal() { /* ... unchanged ... */ }
            function drawSpectrogram() { /* ... unchanged ... */ }
            spectrogramCanvas.addEventListener('click', (event) => { /* ... unchanged ... */ });
            playToneButton.addEventListener('click', () => { /* ... unchanged ... */ });

            trackFreqButton.addEventListener('click', () => {
                const freqToAdd = Math.round(selectedPeakFrequency);
                if (freqToAdd > 0 && !Array.from(TARGET_FREQUENCIES).some(f => Math.abs(f - freqToAdd) < 1)) {
                    TARGET_FREQUENCIES = new Float32Array([...TARGET_FREQUENCIES, freqToAdd]);
                    saveTrackedFrequencies();
                    updateWasmTargets();
                    analysisModal.style.display = 'none';
                }
            });

            function updateLogUI() { /* ... unchanged ... */ }
            function drawRadar() { /* ... unchanged ... */ }
            
            // Initial Draw
            window.addEventListener('resize', drawRadar);
            drawRadar();
        }

        var Module = { onRuntimeInitialized: function() { startApp(Module); } };
    </script>
    <script src="https://cricket-detector.netlify.app/detector.js" async></script>
</body>
</html>

